# Compliance Enforcement System Guide

## Overview

The compliance enforcement system ensures all content generated for the SureWealth project adheres to regulatory requirements for insurance and annuity marketing. The system automatically validates and enforces word/phrase substitutions based on the "Compliant Word and Phrase Alternative" guidelines.

## System Components

### 1. Compliance Rules (`meta_framework/language/compliance_rules.yaml`)

Contains all non-compliant words/phrases and their approved alternatives in structured YAML format. Each rule includes:
- Non-compliant term and variants
- Reason why it's an issue
- Approved alternatives
- Matching rules (word boundary, phrase, etc.)
- Context requirements and exceptions

### 2. Compliance Enforcer (`meta_framework/language/compliance_enforcer.py`)

Core module that:
- Validates text against compliance rules
- Automatically replaces violations with approved alternatives
- Generates compliance reports
- Provides prompt instructions for AI content generation

### 3. Integration with Prompt Builder

The `prompt_builder.py` automatically includes compliance instructions in all AI prompts, ensuring generated content follows rules from the start.

### 4. Compliance Validator Script (`scripts/compliance_validator.py`)

Command-line tool to:
- Scan all project files for violations
- Generate compliance reports
- Auto-fix violations (creates `.fixed` files)

## Usage

### For Content Generation

Compliance is automatically enforced when using `prompt_builder.py`:

```bash
python ai_prompts/prompt_builder.py \
  --format social_post \
  --topic tax_planning \
  --persona engineer_retiree
```

The generated prompt will include compliance requirements automatically.

### For Validation

Validate all files in the project:

```bash
python scripts/compliance_validator.py --path . --report compliance_report.md
```

Validate a specific file:

```python
from meta_framework.language.compliance_enforcer import ComplianceEnforcer

enforcer = ComplianceEnforcer()
violations = enforcer.validate(text)
summary = enforcer.get_compliance_summary(text)
```

### For Auto-Fixing

Auto-fix violations (creates `.fixed` files):

```bash
python scripts/compliance_validator.py --path . --fix
```

### Programmatic Usage

```python
from meta_framework.language.compliance_enforcer import ComplianceEnforcer

# Initialize
enforcer = ComplianceEnforcer()

# Validate text
violations = enforcer.validate("This is the best investment opportunity!")
# Returns list of Violation objects

# Enforce compliance (auto-replace)
enforced_text, violations = enforcer.enforce(text, replace=True)

# Get summary
summary = enforcer.get_compliance_summary(text)
# Returns: {
#   'total_violations': 2,
#   'is_compliant': False,
#   'violations_by_rule': {'Best': 1, 'Invest': 1},
#   ...
# }
```

## Key Compliance Rules

### Critical Terms to Avoid

| Non-Compliant | Approved Alternative | Reason |
|--------------|---------------------|--------|
| Invest/Investments | Purchase/Financial vehicles | Avoids securities language |
| Account | Contract/Policy | Avoids confusion with bank accounts |
| Deposit | Premium/Purchase payment | Banking terminology |
| Free | No obligation | Cannot claim services are free |
| Best/Always/All | Favorable/Usually/Some | Avoids unsubstantiated claims |
| Expert | Knowledgeable/Professional | Avoids fiduciary implications |
| Financial Planner | Financial professional | Licensing requirements |
| Gain/Growth | Interest potential/Accumulation | Avoids securities language |
| Risk free | Protected/Guaranteed | No product is risk-free |
| Savings | Cash value/Policy values | Avoids bank terminology |

### Common Violations

1. **Investment Language**: Using "invest", "investment", "gain", "growth" when discussing annuities
2. **Banking Terms**: Using "account", "deposit", "savings" 
3. **Absolute Claims**: Using "best", "always", "all", "guaranteed returns"
4. **Advisory Terms**: Using "advice", "advisor", "financial planner", "consultation"
5. **Emotional Promises**: Using "peace of mind", "can rest easy", "nothing to lose"

## Integration Points

### 1. AI Prompt Generation

Compliance rules are automatically included in all prompts generated by `prompt_builder.py`. The system adds compliance instructions to ensure AI-generated content follows rules.

### 2. Content Validation

All content should be validated before publication:

```python
from meta_framework.language.compliance_enforcer import ComplianceEnforcer

enforcer = ComplianceEnforcer()
summary = enforcer.get_compliance_summary(content)

if not summary['is_compliant']:
    print(f"Found {summary['total_violations']} violations")
    # Review and fix violations
```

### 3. Pre-Publication Checklist

Before publishing any content:
1. Run compliance validator: `python scripts/compliance_validator.py --path .`
2. Review violations in report
3. Fix or approve exceptions
4. Re-validate before publishing

## Adding New Rules

To add new compliance rules, edit `meta_framework/language/compliance_rules.yaml`:

```yaml
rules:
  - non_compliant: "New Term"
    variants:
      - "new term"
      - "New Term"
    issue: "Why this is an issue"
    alternatives:
      - "approved alternative 1"
      - "approved alternative 2"
    case_sensitive: false
    match_type: "word_boundary"  # or "phrase" or "partial"
```

Then rebuild the pattern cache (automatic on next use).

## Reporting

The compliance validator generates detailed reports showing:
- Total violations per file
- Violations grouped by rule
- Suggested alternatives
- File-by-file breakdown

## Best Practices

1. **Validate Early**: Check compliance during content creation, not just before publication
2. **Review Exceptions**: Some rules have context-based exceptions - review carefully
3. **Use Alternatives**: When violations are found, use suggested alternatives
4. **Document Exceptions**: If a violation is intentional, document why
5. **Regular Audits**: Run full project scans regularly to catch violations

## Troubleshooting

### False Positives

Some matches may be false positives (e.g., "will" as a verb vs. promissory statement). The system includes context checking, but manual review may be needed.

### Pattern Matching Issues

If a term isn't being caught:
1. Check if it's in the variants list
2. Verify match_type is appropriate
3. Check case_sensitive setting

### Performance

For large files, validation may take time. Consider:
- Validating during content creation
- Running scans in background
- Excluding large archive files

## Support

For questions or issues with compliance enforcement:
1. Check `compliance_rules.yaml` for rule definitions
2. Review `compliance_enforcer.py` for implementation details
3. Run validator with `--report` to see detailed violations

